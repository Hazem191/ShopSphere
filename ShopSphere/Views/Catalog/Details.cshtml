@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model Product
@{
    ViewData["Title"] = Model.Name;
    var isRTL = System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("ar");
}

<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-area="" asp-controller="Home" asp-action="Index">@Localizer["الرئيسية"]</a></li>
        <li class="breadcrumb-item"><a asp-area="" asp-controller="Catalog" asp-action="Index">@Localizer["المنتجات"]</a></li>
        <li class="breadcrumb-item active">@Model.Name</li>
    </ol>
</nav>

<div class="row g-5 @(isRTL ? "flex-row-reverse" : "")">
    <div class="col-md-5">
        <div class="card p-0 text-center shadow-sm border-0" style="border-radius:20px; min-height:350px; overflow:hidden; background:#f8f9fa;">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" class="img-fluid w-100 h-100 object-fit-contain" alt="@Model.Name" />
            }
            else
            {
                <div class="d-flex align-items-center justify-content-center h-100 py-5" style="background:linear-gradient(135deg,#f3eeff,#e8d9ff);">
                    <i class="fas fa-box-open" style="font-size:8rem;color:#6c3fc5;opacity:.4;"></i>
                </div>
            }
        </div>
    </div>

    <div class="col-md-7">
        <h1 class="fw-bold mb-1">@Model.Name</h1>
        <p class="text-muted mb-3">SKU: @Model.SKU</p>
        
        <div class="mb-4">
            @if (Model.StockQuantity > 0)
            {
                <span class="badge bg-success fs-6 rounded-pill px-3">
                    <i class="fas fa-check-circle me-1"></i> @Localizer["متوفر"] (@Model.StockQuantity @Localizer["قطعة"])
                </span>
            }
            else
            {
                <span class="badge bg-danger fs-6 rounded-pill px-3">
                    <i class="fas fa-times-circle me-1"></i> @Localizer["نفد من المخزون"]
                </span>
            }
        </div>

        <h2 class="fw-bold mb-4 text-primary" style="font-size:2.5rem;">@Model.Price.ToString("N2") @Localizer["ج.م"]</h2>

        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <div class="mb-4">
                <h6 class="fw-bold text-muted mb-2">@Localizer["الوصف"]</h6>
                <p class="text-muted lh-lg">@Model.Description</p>
            </div>
        }

        <div class="d-flex align-items-center gap-3 mb-5">
            @if (Model.StockQuantity > 0 && !User.IsInRole("Admin"))
            {
                int cartQty = ViewBag.CartQty ?? 0;
                
                <div id="add-btn-container" class="@(cartQty > 0 ? "d-none" : "")">
                    <button type="button" onclick="addToCart(this, @Model.Id)"
                            class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm border-0">
                        <i class="fas fa-cart-plus me-2"></i> @Localizer["أضف إلى السلة"]
                    </button>
                </div>

                <div id="qty-stepper" class="@(cartQty > 0 ? "" : "d-none") d-flex align-items-center bg-light rounded-pill p-1 shadow-sm" style="border: 1px solid #eee;">
                    <button type="button" onclick="changeQty(@Model.Id, -1)" 
                            class="btn btn-white rounded-circle shadow-sm p-0 d-flex align-items-center justify-content-center" 
                            style="width:45px; height:45px; border:1px solid #eee;">
                        <i class="fas fa-minus text-muted"></i>
                    </button>
                    <span id="product-qty" class="fw-bold fs-5 px-4" style="min-width:60px; text-align:center;">@cartQty</span>
                    <button type="button" onclick="changeQty(@Model.Id, 1)" 
                            class="btn btn-white rounded-circle shadow-sm p-0 d-flex align-items-center justify-content-center" 
                            style="width:45px; height:45px; border:1px solid #eee;">
                        <i class="fas fa-plus text-primary"></i>
                    </button>
                </div>
            }
            <a asp-area="" asp-action="Index" class="btn btn-outline-secondary btn-lg rounded-pill px-4">
                <i class="fas fa-@(isRTL ? "arrow-right" : "arrow-left") me-1"></i> @Localizer["عودة"]
            </a>
        </div>

        <hr class="my-4 opacity-10">
        
        <div class="row text-center g-3">
            <div class="col-4">
                <div class="p-3 rounded-4 bg-light shadow-xs">
                    <i class="fas fa-truck text-primary mb-2 d-block fa-lg"></i>
                    <small class="text-muted fw-bold">@Localizer["شحن سريع"]</small>
                </div>
            </div>
            <div class="col-4">
                <div class="p-3 rounded-4 bg-light shadow-xs">
                    <i class="fas fa-shield-alt text-success mb-2 d-block fa-lg"></i>
                    <small class="text-muted fw-bold">@Localizer["دفع آمن"]</small>
                </div>
            </div>
            <div class="col-4">
                <div class="p-3 rounded-4 bg-light shadow-xs">
                    <i class="fas fa-undo text-warning mb-2 d-block fa-lg"></i>
                    <small class="text-muted fw-bold">@Localizer["إرجاع مجاني"]</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="cartToast" class="toast align-items-center text-white border-0 shadow-lg" role="alert" style="border-radius:12px; background:linear-gradient(135deg,#6c3fc5,#9b59b6);">
        <div class="d-flex">
            <div class="toast-body d-flex align-items-center gap-2">
                <i class="fas fa-check-circle"></i>
                <span id="toastMsg"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
<script>
function addToCart(btn, productId) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> @Localizer["جاري الإضافة..."]';
    fetch('/Cart/Add?productId=' + productId, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Show toast
            document.getElementById('toastMsg').textContent = data.message;
            new bootstrap.Toast(document.getElementById('cartToast'), { delay: 3000 }).show();
            
            // Update UI: Hide button, show stepper
            document.getElementById('add-btn-container').classList.add('d-none');
            const stepper = document.getElementById('qty-stepper');
            stepper.classList.remove('d-none');
            document.getElementById('product-qty').textContent = '1';
            
            // Update Navbar Badge
            const badge = document.getElementById('cart-count-badge');
            if (badge) {
                badge.textContent = data.totalItems;
                badge.style.display = '';
            }
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-cart-plus me-2"></i> @Localizer["أضف إلى السلة"]';
    });
}

function changeQty(productId, delta) {
    fetch(`/Cart/UpdateQty?productId=${productId}&delta=${delta}`, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (data.newQty <= 0) {
                // Show add button again
                document.getElementById('add-btn-container').classList.remove('d-none');
                document.getElementById('qty-stepper').classList.add('d-none');
            } else {
                document.getElementById('product-qty').textContent = data.newQty;
            }
            
            // Update Navbar Badge
            const badge = document.getElementById('cart-count-badge');
            if (badge) {
                badge.textContent = data.totalItems;
                badge.style.display = data.totalItems > 0 ? '' : 'none';
            }
        }
    });
}
</script>
}
